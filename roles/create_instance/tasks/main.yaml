- name: Create EC2 instances
  hosts: localhost
  
  tasks:
    - name: Create EC2 instances for worker nodes
      ec2:
        key_name: pipeline
        instance_type: t2.large
        image: ami-0fc20dd1da406780b
        user_data: "{{ USERDATA }}"
        region: us-east-2
        group_id: sg-0cfe69542efa6f501
        wait: yes
        instance_tags:
          Name: worker
          application: "{{ application }}"
        exact_count: 2
        count_tag:
          application: "{{ application }}"
      register: ec2_worker

    - name: Add all instance public IPs to host group
      add_host: hostname={{ item.public_ip }} groups=ec2workers
      loop: "{{ ec2_worker.instances }}"

- hosts: ec2workers
  name: install dependancies
  remote_user: ubuntu
  become: yes
  gather_facts: true 
  tasks:
    - name: install Docker
      apt:
        name: docker.io
        state: present
        update_cache: true

    - name: install APT Transport HTTPS
      apt:
        name: apt-transport-https
        state: present

    - name: add Kubernetes apt-key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present

    - name: add Kubernetes' APT repository
      apt_repository:
        repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
        state: present
        filename: "kubernetes"

    - name: install kubelet
      apt:
        name: kubelet=1.14.0-00
        state: present
        update_cache: true

    - name: install kubeadm
      apt:
        name: kubeadm=1.14.0-00
        state: present